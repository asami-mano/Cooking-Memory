{% extends 'base.html' %}

{% block title %}マイページ{% endblock %}
{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static 'css/sanitize.css' %}">
<link rel="stylesheet" href="{% static 'css/style.css' %}">

<style>
  .main-content {
    margin-top: 100px; /* ヘッダーの高さ分だけ空ける */
    width: 100%;
    max-width: 1000px; /* 入力欄の幅を制限 */
    {% comment %} max-width: 100%;
    margin-left: auto;
    margin-right: auto;
    padding: 0 20px; {% endcomment %}
  }

  img{
    width: 50%;
  }
    
  form div {
    font-size: 40px;
    margin-bottom: 80px;
    width: 100%;
    max-width: 700px; /* 入力欄の幅を制限 */
  }
  div {
    font-size: 40px;
  }
  label {
    display: block;
    font-size: 60px;
  }
  input[type="submit"],
  .custom-button {
    font-size: 50px;
    padding: 10px 20px;
    white-space: nowrap; /* 縦書き防止（折り返さない） */
  }
  .user-name {
    text-align: center;
    margin-top: 20px;
    font-size: 50px;
    display: flex;
    justify-content: left;
    align-items: center;
    gap: 30px; /* ボタンと名前の間のスペース */
  }
  .file-upload-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 30px;
    flex-wrap: wrap; /* 小さい画面でも崩れにくくする */
  }

  input[type="file"] {
    font-size: 50px;
  }

  .mypage-list {
    margin-top: 50px;
    font-size: 2em;
  }
  .mypage-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #ccc;
  }
  .menu-link,
  .arrow {
    color: black;
    text-decoration: none; /* 下線消したい場合 */
  }
  #nameChangeModal {
    font-size: 40px;
    color: gray;
    margin-left: 10px;
    text-decoration: none;
  }

</style>

<div class="main-content">
  <!-- プロフィール画像 -->
  {% if user.image_url %}
    <div style="text-align: center;"><img src="{{ user.image_url.url }}" alt="プロフィール画像"></div>
  {% else %}
    <p>画像がありません</p>
  {% endif %}

  <!-- ファイル選択と登録ボタン -->
  <form method="post" enctype="multipart/form-data" action="{% url 'accounts:upload_profile_image' %}">
    {% csrf_token %}
    <div class="file-upload-container">
      <input type="file" name="image">
      <button type="submit" class="custom-button" style="font-size: 50px;">登録</button>
    </div>
  </form>

  <!-- 名前変更ボタンと名前/ニックネーム -->
  <div class="user-name">
    <button class="custom-button" data-bs-toggle="modal" data-bs-target="#nameChangeModal">名前変更</button>
    <span>{{ user.username }}</span>
  </div>

  <ul class="mypage-list">
    <div class="mypage-item">
      <a class="menu-link" href="{% url 'accounts:change_email' %}">メールアドレス変更</a>
      <a href="{% url 'accounts:change_email' %}" target="_blank" class="arrow">＞</a>
    </div>
    <div class="mypage-item">
      <a class="menu-link" href="{% url 'accounts:change_password' %}">パスワード変更</a>
      <a href="{% url 'accounts:change_password' %}" target="_blank" class="arrow">＞</a>
    </div>
    <div class="mypage-item">
      <a class="menu-link" href="{% url 'accounts:generate_invite' %}">招待用URLの発行</a>
      <a href="{% url 'accounts:generate_invite' %}" target="_blank" class="arrow">＞</a>
    </div>
    <div class="mypage-item">
      <a class="menu-link" href="#" data-bs-toggle="modal" data-bs-target="#shareUsersModal" onclick="share_users()">共有中のユーザー</a>
      <a href="#" data-bs-toggle="modal" data-bs-target="#shareUsersModal" onclick="share_users()" target="_blank" class="arrow">＞</a>
    </div>
  </ul>
        
  <!-- ログアウト -->
  <form method="post" action="{% url 'accounts:user_logout_2' %}">
    {% csrf_token %}
    <button style="font-size: 60px;">ログアウト</button>
  </form>
</div>


<!-- モーダル本体 -->
<div class="modal fade" id="nameChangeModal" tabindex="-1" aria-labelledby="nameChangeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'accounts:change_username' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="nameChangeModalLabel">名前/ニックネーム</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="username" value="{{ user.username }}" class="form-control">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" style="font-size: 30px;">変更</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="shareUsersModal" tabindex="-1" aria-labelledby="shareUsersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="shareUsersModalLabel">共有中のユーザー</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <!-- ここに共有ユーザーのリストを表示 -->
          <ul id="shareUsersList"></ul>
        </div>
      </div>
    </div>
  </div>


<script>
  function share_users() {
      fetch("{% url 'accounts:share_users' %}")
          .then(response => response.json())
          .then(data => {
              const userListDiv = document.getElementById("shareUsersList");
              userListDiv.innerHTML = "";// 既存のリストをクリア
              
              if (data.users.length > 0) {                  
                  data.users.forEach(user => {
                    const li = document.createElement("li");
                    li.textContent = user.name;
                    userListDiv.appendChild(li);
               });
              } else {
                  userListDiv.innerHTML = "<p>共有中のユーザーはいません。</p>";
              }
          })
          .catch(error => {
              document.getElementById("shareUsersList").innerHTML = "<p>読み込みに失敗しました。</p>";
              console.error("エラー:", error);
          });
  }
  </script>
  
{% endblock %}

