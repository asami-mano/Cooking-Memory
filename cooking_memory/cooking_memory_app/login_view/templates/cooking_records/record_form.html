{% extends 'base.html' %}
{% block content %}

<style>
  form {
      display: flex;
      flex-direction: column;
      align-items: center; /* å­è¦ç´ ï¼ˆå…¥åŠ›æ¬„ãƒ»ãƒœã‚¿ãƒ³ï¼‰ã‚’ä¸­å¤®ã« */
      margin-top: 5%;
  }

  form div {
      margin-bottom: 50px;
      width: 100%;
      max-width: 800px; /* å…¥åŠ›æ¬„ã®å¹…ã‚’åˆ¶é™ */
  }
  label {
      display: block;
      font-size: 60px;
  }

  .form-group {
    font-size: 60px;
    font-weight: bold;
    margin-bottom: 50px;
  }

  .form-group label {
    margin-bottom: 6px;
    font-weight: bold;
  }

  .form-group textarea {
    width: 80%;
    padding: 8px;
    border-radius: 8px;
  }

  .star-rating {
    display: inline-flex;#æ¨ªä¸¦ã³ã«ã™ã‚‹
    gap: 4px;#æ˜Ÿã®é–“ã«4pxã®éš™é–“
    direction: ltr;
    font-size: 60px;
  }
  .star-rating input[type="radio"] {
    display: none;
  }
  .star-rating label {
    font-size: 100px;
    color: #ccc;
    cursor: pointer;
  }
  .star-rating input[type="radio"]:checked ~ label {
    color:rgb(8, 6, 0);
  }
  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: #f5c518;
  }

  .easiness-labels {
    font-size: 32px;
    margin-top: 10px;
    text-align: center;
  }

  .favorite-btn {
    font-size: 100px;
    background: none;
    border: none;
    cursor: pointer;
  }

  button[type="submit"] {
    font-size: 60px;
    padding: 10px 30px;
}

  .easiness-labels {
    margin-top: 5px;
    font-size: 30px;
  }

  .btn-outline-secondary{
    font-size: 50px;
    padding: 12px 24px;
  }

  #open-category-modal {
    font-size: 30px;
    color: gray;
    margin-left: 10px;
    text-decoration: none;
  }

  #selected-recipes {
    margin-top: 10px;
  }

</style>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}


  {% if form.errors %}
  <div class="alert alert-danger">
      <strong>ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™</strong>
      <ul>
      {% for field in form %}
          {% for error in field.errors %}
          <li>{{ field.label }}: {{ error }}</li>
          {% endfor %}
      {% endfor %}
      {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
      {% endfor %}
      </ul>
  </div>
  {% endif %}


  <div id="photoPreviewArea" style="margin-top: 10px;">
    <img id="photoPreview" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width: 100%; display: none;">
  </div>
  <button type="button" id="openPhotoModal">ğŸ“·</button>

  <div>
      <div class="form-group">
    {{ form.date.label }} {{ form.date }}
  </div>
  <div class="form-group">
    {{ form.cooking_category.label }} {{ form.cooking_category }}
    <a href="#" id="open-category-modal">ï¼‹æ–°è¦ä½œæˆ</a>
  </div>
  <div class="form-group">
    <label>èª¿ç†ã®æ‰‹è»½ã•</label>
    <div class="star-rating">
      <input type="radio" id="easiness-3" name="cooking_easiness" value="2">
      <label for="easiness-3">â˜…</label>

      <input type="radio" id="easiness-2" name="cooking_easiness" value="1" checked>
      <label for="easiness-2">â˜…</label>

      <input type="radio" id="easiness-1" name="cooking_easiness" value="0">
      <label for="easiness-1">â˜…</label>
    </div>
    <div class="easiness-labels">
      <span>â˜…ç°¡å˜  â˜…â˜…æ™®é€š  â˜…â˜…â˜…æ‰‹é–“ãŒã‹ã‹ã‚‹</span>
    </div>
  </div>
  <div class="form-group">
    <label>ãŠæ°—ã«å…¥ã‚Š</label>
    <button class="favorite-btn" id="favorite-btn">
      ğŸ¤
    </button>
  </div>
  <div class="form-group">
    {{ form.memo.label }}<br> 
    {{ form.memo }}
  </div>
  <div class="form-group">
    <label>å‚è€ƒãƒ¬ã‚·ãƒ”</label>
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#recipeModal">
      ï¼‹ ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆ
    </button>
  </div>
  <div id="selected-recipes">
    <input type="hidden" name="recipes" id="selectedRecipeIds">
    <ul id="selectedRecipesList" class="list-group"></ul>
  </div>

  <!-- hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”¨ï¼ˆæœ€åˆã¯ç©ºï¼‰ -->
  <div id="selectedRecipesHiddenArea" style="display:none;"></div>

  <button type="submit">ç™»éŒ²</button>
</form>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ -->
<div class="modal" id="photoModal" style="display:none;">
  <div class="modal-content">
    <button id="closeModal" class="close-btn" style="position:absolute; top:5px; right:10px; border:none; background:none; font-size:20px; cursor:pointer;">âœ–ï¸</button>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div id="cameraPreview" style="display:none;">
      <video id="video" autoplay playsinline></video><br>
      <button id="takePhoto">ğŸ“·</button>
    </div>

    <!-- ã‚¢ãƒ«ãƒãƒ é¸æŠ -->
    <div id="albumSelect">
      <input type="file" id="fileInput" accept="image/*">
    </div>

    <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="tab-buttons">
      <button id="albumTab" type="button">ã‚¢ãƒ«ãƒãƒ </button>
      <button id="cameraTab" type="button">ã‚«ãƒ¡ãƒ©</button>
    </div>
  </div>
</div>

<div id="category-modal" style="display:none; position:fixed; top:30%; left:30%; background:#fff; border:1px solid #ccc; padding:20px;">
  <h3>æ–°è¦ã‚«ãƒ†ã‚´ãƒª</h3>
  <form id="category-form">
    {% csrf_token %}
    <input type="text" id="new-category-name" placeholder="ã‚«ãƒ†ã‚´ãƒªå" required><br>
    <button type="submit">ä½œæˆ</button>
    <button type="button" onclick="closeModal()" style="position:absolute; top:5px; right:10px; border:none; background:none; font-size:20px; cursor:pointer;">âœ–ï¸</button>
  </form>
</div>

<div class="modal fade" id="recipeModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">ãƒ¬ã‚·ãƒ”ã‚’é¸æŠ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        {% if recipes %}
          {% for recipe in recipes %}
            <div>
              <input type="checkbox" name="recipes" value="{{ recipe.id }}" data-name="{{ recipe.name }}"> {{ recipe.name }}
            </div>
          {% endfor %}
        {% else %}
          <p>ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“</p>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="addRecipes">ãƒ¬ã‚·ãƒ”ã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const photoModal = document.getElementById('photoModal');
    const closeModalBtn = document.getElementById('closeModal');
    const albumTab = document.getElementById('albumTab');
    const cameraTab = document.getElementById('cameraTab');
    const albumSelectArea = document.getElementById('albumSelect');
    const cameraPreviewArea = document.getElementById('cameraPreview');
    const fileInput = document.getElementById('fileInput');
    const video = document.getElementById('video');
    const takePhotoBtn = document.getElementById('takePhoto');
    const previewImg = document.getElementById('photoPreview');

    let stream; // ã‚«ãƒ¡ãƒ©ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ä¿å­˜ç”¨
  
    // ğŸ“·ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    document.getElementById('openPhotoModal').addEventListener('click', function() {
      photoModal.style.display = 'block';
      showCamera(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
    });
  
    // é–‰ã˜ã‚‹
    closeModalBtn.addEventListener('click', function() {
      photoModal.style.display = 'none';
      stopCamera();
    });
  
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    albumTab.addEventListener('click', showAlbum);
    cameraTab.addEventListener('click', showCamera);
  
    function showAlbum() {
      albumSelectArea.style.display = 'block';
      cameraPreviewArea.style.display = 'none';
      stopCamera();
    }
  
    async function showCamera() {
      albumSelectArea.style.display = 'none';
      cameraPreviewArea.style.display = 'block';
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        console.error('ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
        alert('ã‚«ãƒ¡ãƒ©ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“');
        showAlbum();
      }
    }
  
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }
  
    // ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸ã‚“ã ã¨ãã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    fileInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          previewImg.style.display = 'block'; // è¡¨ç¤ºã•ã›ã‚‹
        };
        reader.readAsDataURL(file);
    
        photoModal.style.display = 'none';
      }
    });
    
    // ã‚«ãƒ¡ãƒ©ã§æ’®ã£ãŸã¨ãã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    takePhotoBtn.addEventListener('click', function() {
      if (video.readyState < 2) { // HAVE_CURRENT_DATAæœªæº€ãªã‚‰ã¾ã ã‚«ãƒ¡ãƒ©æ˜ ã£ã¦ãªã„
        alert('ã‚«ãƒ¡ãƒ©ãŒã¾ã æº–å‚™ã§ãã¦ãªã„ã‚ˆï¼');
        return;
      }
      
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
      const dataUrl = canvas.toDataURL('image/jpeg');

      previewImg.src = dataUrl;
      previewImg.style.display = 'block'; // è¡¨ç¤ºã•ã›ã‚‹
  
      photoModal.style.display = 'none';
      stopCamera();
    });
  });

  document.getElementById("open-category-modal").addEventListener("click", function(e) {
    e.preventDefault();
    document.getElementById("category-modal").style.display = "block";
  });
  
  function closeModal() {
    document.getElementById("category-modal").style.display = "none";
  }
  
  // æ–°è¦ã‚«ãƒ†ã‚´ãƒªä½œæˆ
  document.getElementById("category-form").addEventListener("submit", function(e) {
    e.preventDefault();
    const name = document.getElementById("new-category-name").value;
  
    fetch(`/cooking_records/create_category/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ name: name }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // ã‚»ãƒ¬ã‚¯ãƒˆã«è¿½åŠ 
        const select = document.getElementById("id_cooking_category");
        const option = document.createElement("option");
        option.value = data.id;
        option.text = data.name;
        option.selected = true;
        select.appendChild(option);
  
        closeModal();
      } else {
        alert("ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    });
  });

  // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
  document.addEventListener('DOMContentLoaded', function() {
    const favoriteBtn = document.querySelector('.favorite-btn');
    let isFavorite = false;  // åˆæœŸçŠ¶æ…‹ï¼ˆæ–°è¦ä½œæˆã®å ´åˆï¼‰

    favoriteBtn.addEventListener('click', function(event) {
      event.preventDefault();  // ãƒœã‚¿ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ç­‰ï¼‰ã‚’é˜²ã
      isFavorite = !isFavorite;  // çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ

      // æ–°è¦ä½œæˆã®å ´åˆã€APIå‘¼ã³å‡ºã—
      fetch(`/cooking_records/create_toggle_favorite/`, {  // Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã§URLã‚’ç”Ÿæˆ
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
        },
        body: JSON.stringify({
          record_id: {{ record.id|default:"null" }},
          is_favorite: isFavorite ? 1 : 0
        })
      })
      .then(response => response.json())
      .then(data => {
        favoriteBtn.textContent = data.is_favorite ? 'â¤ï¸' : 'ğŸ¤';
      })
      .catch(error => {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
      });
    });
  });

  document.getElementById('addRecipes').addEventListener('click', function() {
    // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ã‚’å–å¾—
    const checkedBoxes = document.querySelectorAll('input[name="recipes"]:checked');
  
    // è¿½åŠ ã™ã‚‹å…ˆã®ãƒªã‚¹ãƒˆ
    const selectedList = document.getElementById('selectedRecipesList');
    const selectedIds = [];

    // ã¾ãšã€ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    selectedList.innerHTML = '';

    // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ã‚’å…¨éƒ¨ãƒªã‚¹ãƒˆã¨hidden inputã«è¿½åŠ 
    checkedBoxes.forEach(box => {
      const recipeId = box.value;
      const recipeName = box.dataset.name;// ãƒ¬ã‚·ãƒ”åã‚’å–ã‚‹
  
      selectedIds.push(recipeId);

      // ç”»é¢è¡¨ç¤ºç”¨ãƒªã‚¹ãƒˆ
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = recipeName;
      selectedList.appendChild(li);
    });
  
    // é¸æŠã—ãŸãƒ¬ã‚·ãƒ”IDã‚’ hidden input ã«ã¾ã¨ã‚ã¦ã‚»ãƒƒãƒˆ
    const hiddenArea = document.getElementById('selectedRecipesHiddenArea');
    hiddenArea.innerHTML = '';
    selectedIds.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'recipes';
      input.value = id;
      hiddenArea.appendChild(input);
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const recipeModal = bootstrap.Modal.getInstance(document.getElementById('recipeModal'));
    recipeModal.hide();
  });

</script>
  
  {% endblock  %}