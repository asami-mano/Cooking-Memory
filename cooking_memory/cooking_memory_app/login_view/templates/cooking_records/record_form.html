{% extends 'base.html' %}
{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static 'css/sanitize.css' %}">
<link rel="stylesheet" href="{% static 'css/style.css' %}">

<style>
  .main-content {
    margin-top: 100px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•åˆ†ã ã‘ç©ºã‘ã‚‹ */
  }

.create-btn{
  color: blue;
  text-decoration: underline;
  font-size: 30px;
}

  .modal-content {
    text-align: left;
    width: 100%;
    font-size: 40px;
  }

  .modal-body input[type="checkbox"] {
    width: 40px;
    height: 40px;
    margin-right: 8px;
  }

  input[type="date"] {
    flex-grow: 1;
    min-width: 200px;
  }
  
  .emoji-rating{
    display: flex;
    gap: 30px;
    font-size: 100px;
    align-items: center;
  }
  .emoji-rating input[type="radio"] {
    display: none;
  }
  .emoji-rating label {
    cursor: pointer;
    opacity: 0.4;
    transition: opacity 0.2s;
    font-size: 100px;
  }
  .emoji-rating input[type="radio"]:checked + label {
    opacity: 1;
  }
  
  #favoriteBtn {
    font-size: 100px;
    background: none;
    border: none;
    cursor: pointer;
  }
  
  .list-group {
    font-size: 40px;
  }  
</style>

<div class="main-content" style="text-align: left;">
  <form method="post" enctype="multipart/form-data" action="{% url 'cooking_records:cooking_record_create' %}">
    {% csrf_token %}


    {% if form.errors %}
    <div class="alert alert-danger" style="color: red; font-size: 2em;">
        <strong>ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™</strong>
        <ul>
        {% for field in form %}
            {% for error in field.errors %}
            <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- ã“ã“ã«éš ã—fileInputã‚’è¨­ç½® -->
    <input type="file" id="fileInput" name="image_url" accept="image/*" style="display: none;">

    <div id="photoPreviewArea" style="margin-top: 1px;">
      <img id="photoPreview" src="" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width: 100%; display: none;">
    </div>

    <button id="selectFromAlbum" type="button" style="font-size: 60px; margin-bottom: 40px;">ï¼‹å†™çœŸç™»éŒ²</button>

    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
      <label for="{{ form.date.id_for_label }}" style="white-space: nowrap;">{{ form.date.label }}</label>
      {{ form.date }}
    </div>
    {% comment %} <div class="form-group">
      {{ form.date.label }} {{ form.date }}
    </div> {% endcomment %}

    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
      <label>{{ form.cooking_category.label }}</label> {{ form.cooking_category }}
      <a href="#" data-bs-toggle="modal" data-bs-target="#category-modal" class="create-btn" style="color: blue; text-decoration: underline; font-size: 40px;">ï¼‹æ–°è¦ä½œæˆ</a>
    </div>

    <div class="form-group" style="text-align: left;">
      <label>èª¿ç†ã®æ‰‹è»½ã•</label>
      <div class="emoji-rating">
        <input type="radio" id="easy" name="cooking_easiness" value="0">
        <label for="easy" title="ç°¡å˜">ğŸ˜Š</label>
    
        <input type="radio" id="normal" name="cooking_easiness" value="1" checked>
        <label for="normal" title="æ™®é€š">ğŸ™‚</label>
    
        <input type="radio" id="hard" name="cooking_easiness" value="2">
        <label for="hard" title="æ‰‹é–“ãŒã‹ã‹ã‚‹">ğŸ˜£</label>
      </div>
      <div class="easiness-labels" style="font-size: 40px;">
        <span>ç°¡å˜ï¼šğŸ˜Šã€€æ™®é€šï¼šğŸ™‚ã€€æ‰‹é–“ãŒã‹ã‹ã‚‹ï¼šğŸ˜£</span>
      </div>
    </div>
    
    <div class="form-group">
      <label>ãŠæ°—ã«å…¥ã‚Š</label>
      <button type="button" id="favoriteBtn" data-is-favorite="0">ğŸ¤</button>
      <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥ã‚Œã‚‹ -->
      <input type="hidden" name="is_favorite" id="isFavoriteInput" value="0">
    </div>

    <div class="form-group">
      <label for="{{ form.memo.id_for_label }}">{{ form.memo.label }}</label>
      {{ form.memo }}
    </div>
    
    <div class="form-group">
      <label>å‚è€ƒãƒ¬ã‚·ãƒ”</label>
      <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#recipeModal">
        ï¼‹ ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆ
      </button>
    </div>
    <div id="selected-recipes">
      <input type="hidden" name="recipes" id="selectedRecipeIds">
      <ul id="selectedRecipesList" class="list-group"></ul>
    </div>

    <!-- hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”¨ï¼ˆæœ€åˆã¯ç©ºï¼‰ -->
    <div id="selectedRecipesHiddenArea" style="display:none;"></div>

    <button type="submit">ç™»éŒ²</button>
  </form>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ -->
{% comment %} <div class="modal" id="photoModal" style="display:none;">
  <div class="modal-content">
    <button id="closeModal" class="close-btn" style="position:absolute; top:5px; right:20px; border:none; background:none; cursor:pointer;">âœ–ï¸</button>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
    <div id="cameraPreview" style="display:none;">
      <video id="video" autoplay playsinline></video><br>
      <button id="takePhoto" style="font-size: 80px; margin-top:20px; margin-bottom:20px;">ğŸ“·</button>
    </div>

    <!-- ã‚¢ãƒ«ãƒãƒ é¸æŠ -->
    <div id="albumSelect">
      <button id="selectFromAlbum">ã‚¢ãƒ«ãƒãƒ ã‹ã‚‰é¸ã¶</button>
    </div>

    <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
    <div class="tab-buttons">
      <button id="albumTab" type="button">ã‚¢ãƒ«ãƒãƒ </button>
      <button id="cameraTab" type="button">ã‚«ãƒ¡ãƒ©</button>
    </div>
  </div>
</div> {% endcomment %}

<div class="modal fade" id="category-modal" tabindex="-1">
  <div class="modal-dialog modal-xl" style="max-width: 60%;">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">æ–°è¦ã‚«ãƒ†ã‚´ãƒª</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        {% csrf_token %}
        <input type="text" id="new-category-name" placeholder="ã‚«ãƒ†ã‚´ãƒªå" required><br>
      </div>

      {% comment %} <form id="category-form">
        {% csrf_token %}
        <input type="text" id="new-category-name" placeholder="ã‚«ãƒ†ã‚´ãƒªå" required><br>
      </form> {% endcomment %}
    
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="addCategories" style="font-size: 40px;">ä½œæˆ</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="recipeModal" tabindex="-1">
  <div class="modal-dialog modal-xl" style="max-width: 90%;">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">ãƒ¬ã‚·ãƒ”ã‚’é¸æŠ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" style="text-align: left;">
        {% if recipes %}
          {% for recipe in recipes %}
            <div>
              <input type="checkbox" name="recipes" value="{{ recipe.id }}" data-name="{{ recipe.name }}" > {{ recipe.name }}
            </div>
          {% endfor %}
        {% else %}
          <p>ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“</p>
        {% endif %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="addRecipes" style="font-size: 40px;">ãƒ¬ã‚·ãƒ”ã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('photoPreview');
    const selectFromAlbumBtn = document.getElementById('selectFromAlbum');
  
    // ğŸ“·ãƒœã‚¿ãƒ³æŠ¼ã—ãŸã‚‰ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’é–‹ã
    selectFromAlbumBtn.addEventListener('click', function() {
      console.log('ğŸ“·ãƒœã‚¿ãƒ³æŠ¼ã•ã‚ŒãŸ');
      fileInput.click();
    });

    // fileInputã§ãƒ•ã‚¡ã‚¤ãƒ«é¸ã‚“ã ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
    fileInput.addEventListener('change', function(event) {
      console.log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã•ã‚ŒãŸ');
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          console.log('èª­ã¿è¾¼ã¿å®Œäº†');
          previewImg.src = e.target.result;
          previewImg.style.display = 'block'; // è¡¨ç¤ºã•ã›ã‚‹
        };
        reader.readAsDataURL(file);
      }
    });
  });
  
  document.addEventListener("DOMContentLoaded", function () {
    // æ–°è¦ã‚«ãƒ†ã‚´ãƒªä½œæˆãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const addBtn = document.getElementById("addCategories");
    if (!addBtn) {
      console.error("addCategoriesãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }

    addBtn.addEventListener("click", function (e) {
      e.preventDefault();
      const name = document.getElementById("new-category-name").value.trim();
      if (!name) {
        alert("ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
  
    fetch(`/cooking_records/create_category/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ name: name }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
        const select = document.getElementById("id_cooking_category");
        const option = document.createElement("option");
        option.value = data.id;
        option.text = data.name;
        option.selected = true;
        select.appendChild(option);
  
        const modalEl = document.getElementById("category-modal");
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.hide();
      } else {
        alert("ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    })
    .catch(error => {
      console.error("ã‚¨ãƒ©ãƒ¼:", error);
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    });
  });
});

  // ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
  document.addEventListener('DOMContentLoaded', function() {
    const favoriteBtn = document.getElementById('favoriteBtn');
    const isFavoriteInput = document.getElementById('isFavoriteInput');
  
    favoriteBtn.addEventListener('click', function() {
      // ã„ã¾ã®çŠ¶æ…‹ã‚’å–å¾—
      let isFavorite = favoriteBtn.dataset.isFavorite === '1';
  
      // ãƒˆã‚°ãƒ«ï¼ˆåè»¢ï¼‰
      isFavorite = !isFavorite;
  
      // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®åˆ‡ã‚Šæ›¿ãˆ
      favoriteBtn.textContent = isFavorite ? 'â¤ï¸' : 'ğŸ¤';
  
      // ãƒ‡ãƒ¼ã‚¿å±æ€§ã¨éš ã—inputã‚‚æ›´æ–°
      favoriteBtn.dataset.isFavorite = isFavorite ? '1' : '0';
      isFavoriteInput.value = isFavorite ? '1' : '0';
    });
  });
  
  document.getElementById('addRecipes').addEventListener('click', function() {
    // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸãƒ¬ã‚·ãƒ”ã‚’å–å¾—
    const checkedBoxes = document.querySelectorAll('input[name="recipes"]:checked');
  
    // è¿½åŠ ã™ã‚‹å…ˆã®ãƒªã‚¹ãƒˆ
    const selectedList = document.getElementById('selectedRecipesList');
    const selectedIds = [];

    // ã¾ãšã€ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
    selectedList.innerHTML = '';

    // ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ã‚’å…¨éƒ¨ãƒªã‚¹ãƒˆã¨hidden inputã«è¿½åŠ 
    checkedBoxes.forEach(box => {
      const recipeId = box.value;
      const recipeName = box.dataset.name;// ãƒ¬ã‚·ãƒ”åã‚’å–ã‚‹
  
      selectedIds.push(recipeId);

      // ç”»é¢è¡¨ç¤ºç”¨ãƒªã‚¹ãƒˆ
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = recipeName;
      selectedList.appendChild(li);
    });
  
    // é¸æŠã—ãŸãƒ¬ã‚·ãƒ”IDã‚’ hidden input ã«ã¾ã¨ã‚ã¦ã‚»ãƒƒãƒˆ
    const hiddenArea = document.getElementById('selectedRecipesHiddenArea');
    hiddenArea.innerHTML = '';
    selectedIds.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'recipes';
      input.value = id;
      hiddenArea.appendChild(input);
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.activeElement.blur();  //ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
    const recipeModal = bootstrap.Modal.getInstance(document.getElementById('recipeModal'));
    recipeModal.hide();
  });

</script>
  
  {% endblock  %}